<!doctype html>
<html lang="ru">
  <head>
    <meta charset="UTF-8" />
    <title>Nova Raya Client</title>
    <style>
      * {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
      }

      html,
      body {
        width: 100%;
        height: 100%;
        font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
          sans-serif;
        color: #0f172a;
      }

      body {
        background: #0f172a;
        display: flex;
        align-items: stretch;
        justify-content: center;
      }

      .app {
        background: #f8fafc;
        width: 100%;
        height: 100%;
        display: flex;
        flex-direction: column;
      }

      .app-header {
        height: 48px;
        padding: 0 16px;
        border-bottom: 1px solid #e2e8f0;
        display: flex;
        align-items: center;
        justify-content: space-between;
        background: #ffffff;
      }

      .app-header-left {
        display: flex;
        align-items: center;
        gap: 8px;
        font-weight: 600;
      }

      .app-dot {
        width: 10px;
        height: 10px;
        border-radius: 999px;
        background: #22c55e;
      }

      .app-header-right {
        font-size: 12px;
        color: #64748b;
        display: flex;
        align-items: center;
        gap: 10px;
      }

      .reset-btn {
        font-size: 11px;
        padding: 3px 8px;
        border-radius: 999px;
        border: 1px solid #e2e8f0;
        background: #ffffff;
        cursor: pointer;
      }

      .reset-btn:hover {
        background: #fee2e2;
        border-color: #fecaca;
      }

      .app-body {
        flex: 1;
        display: grid;
        grid-template-columns: 260px 1fr;
        height: calc(100% - 48px);
      }

      /* SIDEBAR */

      .sidebar {
        border-right: 1px solid #e2e8f0;
        background: #f1f5f9;
        display: flex;
        flex-direction: column;
      }

      .sidebar-block {
        padding: 10px 12px 6px;
        border-bottom: 1px solid #e2e8f0;
      }

      .sidebar-title {
        font-size: 11px;
        text-transform: uppercase;
        letter-spacing: 0.08em;
        color: #94a3b8;
        margin-bottom: 4px;
      }

      .sidebar-row {
        display: flex;
        align-items: center;
        justify-content: space-between;
        font-size: 13px;
        color: #475569;
      }

      .sidebar-row + .sidebar-row {
        margin-top: 4px;
      }

      .sidebar-action {
        font-size: 12px;
        color: #2563eb;
        cursor: pointer;
        border-radius: 6px;
        padding: 2px 6px;
      }

      .sidebar-action:hover {
        background: #dbeafe;
      }

      .sidebar-actions-inline {
        display: flex;
        gap: 6px;
        font-size: 11px;
      }

      .sidebar-mini-btn {
        border: none;
        background: transparent;
        padding: 0;
        font-size: 11px;
        color: #64748b;
        cursor: pointer;
        text-decoration: underline;
        text-decoration-style: dotted;
      }

      .sidebar-mini-btn:hover {
        color: #0f172a;
      }

      .sidebar-mini-btn.danger:hover {
        color: #b91c1c;
      }

      .projects-list,
      .chats-list {
        padding: 4px;
        overflow-y: auto;
      }

      .sidebar-item {
        padding: 7px 9px;
        border-radius: 8px;
        margin-bottom: 4px;
        cursor: pointer;
        font-size: 13px;
        display: flex;
        flex-direction: column;
        gap: 2px;
        text-align: left;
        border: 1px solid transparent;
      }

      .sidebar-item span:first-child {
        font-weight: 500;
      }

      .sidebar-item span:last-child {
        font-size: 11px;
        color: #94a3b8;
      }

      .sidebar-item.active {
        background: #e0f2fe;
        border-color: #94a3b8;
      }

      .sidebar-item:not(.active):hover {
        background: #e5e7eb;
      }

      /* MAIN CHAT */

      .chat-main {
        display: flex;
        flex-direction: column;
        height: 100%;
      }

      .chat-top-bar {
        padding: 12px 18px;
        border-bottom: 1px solid #e2e8f0;
        background: #ffffff;
        display: flex;
        align-items: center;
        justify-content: space-between;
        font-size: 13px;
      }

      .chat-top-title {
        font-weight: 600;
      }

      .chat-top-subtitle {
        font-size: 11px;
        color: #94a3b8;
        margin-top: 2px;
      }

      .chat-top-right {
        font-size: 11px;
        color: #94a3b8;
      }

      .chat-history {
        flex: 1;
        padding: 16px 20px;
        overflow-y: auto;
        background: radial-gradient(circle at top, #e0f2fe 0, #f8fafc 40%);
      }

      .msg {
        max-width: 70%;
        padding: 10px 13px;
        border-radius: 10px;
        margin-bottom: 12px;
        font-size: 14px;
        line-height: 1.4;
        white-space: pre-wrap;
      }

      .msg-user {
        margin-left: auto;
        background: #020617;
        color: #f8fafc;
        border-bottom-right-radius: 2px;
      }

      .msg-raya {
        margin-right: auto;
        background: #ffffff;
        border: 1px solid #e2e8f0;
        border-bottom-left-radius: 2px;
      }

      .msg-meta {
        font-size: 11px;
        color: #94a3b8;
        margin-bottom: 4px;
      }

      .chat-input {
        border-top: 1px solid #e2e8f0;
        padding: 10px 14px;
        background: #ffffff;
        display: flex;
        flex-direction: column;
        gap: 4px;
      }

      .chat-input-inner {
        display: flex;
        gap: 8px;
      }

      .chat-input textarea {
        flex: 1;
        resize: none;
        border-radius: 10px;
        border: 1px solid #cbd5f5;
        padding: 8px 10px;
        font-size: 14px;
        font-family: inherit;
        outline: none;
      }

      .chat-input textarea:focus {
        border-color: #3b82f6;
        box-shadow: 0 0 0 1px rgba(59, 130, 246, 0.3);
      }

      .send-btn {
        border: none;
        border-radius: 10px;
        padding: 0 18px;
        background: #020617;
        color: #f8fafc;
        font-size: 14px;
        font-weight: 500;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .send-btn:disabled {
        opacity: 0.5;
        cursor: default;
      }

      .send-btn span {
        margin-left: 6px;
        font-size: 12px;
        text-transform: uppercase;
        letter-spacing: 0.04em;
      }

      .chat-hint {
        font-size: 11px;
        color: #94a3b8;
        padding: 0 2px;
      }
    </style>
  </head>
  <body>
    <div class="app">
      <header class="app-header">
        <div class="app-header-left">
          <div class="app-dot"></div>
          <div>Nova Raya Client</div>
        </div>
        <div class="app-header-right">
          <button id="reset-btn" class="reset-btn">Сбросить всё</button>
          <span>Локальный клиент. Пока без API-ключа, просто болтаем.</span>
        </div>
      </header>

      <div class="app-body">
        <!-- SIDEBAR -->
        <aside class="sidebar">
          <div class="sidebar-block">
            <div class="sidebar-title">Проекты</div>
            <div class="sidebar-row">
              <span id="current-project-label">—</span>
              <span id="add-project-btn" class="sidebar-action">+ проект</span>
            </div>
            <div class="sidebar-row">
              <div class="sidebar-actions-inline">
                <button
                  id="rename-project-btn"
                  type="button"
                  class="sidebar-mini-btn"
                >
                  Переименовать
                </button>
                <button
                  id="delete-project-btn"
                  type="button"
                  class="sidebar-mini-btn danger"
                >
                  Удалить
                </button>
              </div>
            </div>
          </div>
          <div id="projects-list" class="projects-list"></div>

          <div class="sidebar-block">
            <div class="sidebar-title">Чаты проекта</div>
            <div class="sidebar-row">
              <span id="current-chat-label">—</span>
              <span id="add-chat-btn" class="sidebar-action">+ чат</span>
            </div>
            <div class="sidebar-row">
              <div class="sidebar-actions-inline">
                <button
                  id="rename-chat-btn"
                  type="button"
                  class="sidebar-mini-btn"
                >
                  Переименовать
                </button>
                <button
                  id="delete-chat-btn"
                  type="button"
                  class="sidebar-mini-btn danger"
                >
                  Удалить
                </button>
              </div>
            </div>
          </div>
          <div id="chats-list" class="chats-list"></div>
        </aside>

        <!-- MAIN CHAT -->
        <main class="chat-main">
          <div class="chat-top-bar">
            <div>
              <div id="chat-title" class="chat-top-title">Новый диалог</div>
              <div id="chat-subtitle" class="chat-top-subtitle">
                Выбери проект и чат слева.
              </div>
            </div>
            <div class="chat-top-right" id="chat-meta">
              0 сообщений
            </div>
          </div>

          <div id="chat-history" class="chat-history"></div>

          <form id="chat-form" class="chat-input">
            <div class="chat-input-inner">
              <textarea
                id="chat-input"
                rows="2"
                placeholder="Напиши что-нибудь Рае…"
              ></textarea>
              <button id="send-btn" class="send-btn" type="submit" disabled>
                ➤ <span>Send</span>
              </button>
            </div>
            <div class="chat-hint">
              Enter — отправить • Shift+Enter — перенос строки
            </div>
          </form>
        </main>
      </div>
    </div>

    <script>
      const STORAGE_KEY = "nova-raya-projects-v1";

      function makeId() {
        return Math.random().toString(36).slice(2, 10);
      }

      function buildInitialState() {
        const initialProjectId = makeId();
        const initialChatId = makeId();
        return {
          projects: [
            {
              id: initialProjectId,
              name: "Demo проект",
              description: "Первый локальный проект",
              chats: [
                {
                  id: initialChatId,
                  title: "Новый диалог",
                  messages: [
                    {
                      id: makeId(),
                      role: "raya",
                      text:
                        "Привет, я твой локальный клиент. Пиши сообщение внизу — " +
                        "я отвечу сюда же, пока в режиме «заглушки», без реального API.",
                      ts: new Date().toLocaleTimeString().slice(0, 5),
                    },
                  ],
                },
              ],
            },
          ],
          activeProjectId: initialProjectId,
          activeChatId: initialChatId,
        };
      }

      function loadState() {
        const raw = localStorage.getItem(STORAGE_KEY);
        if (!raw) return buildInitialState();
        try {
          const parsed = JSON.parse(raw);
          if (!parsed.projects || !parsed.projects.length) {
            throw new Error("no projects");
          }
          return parsed;
        } catch (e) {
          console.warn("Ошибка чтения state, создаю новый:", e);
          localStorage.removeItem(STORAGE_KEY);
          return buildInitialState();
        }
      }

      let state = loadState();

      function saveState() {
        localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
      }

      function getActiveProject() {
        return state.projects.find((p) => p.id === state.activeProjectId) || null;
      }

      function getActiveChat() {
        const project = getActiveProject();
        if (!project) return null;
        return project.chats.find((c) => c.id === state.activeChatId) || null;
      }

      // --- DOM элементы ---

      const projectsListEl = document.getElementById("projects-list");
      const chatsListEl = document.getElementById("chats-list");
      const currentProjectLabelEl =
        document.getElementById("current-project-label");
      const currentChatLabelEl = document.getElementById("current-chat-label");
      const chatTitleEl = document.getElementById("chat-title");
      const chatSubtitleEl = document.getElementById("chat-subtitle");
      const chatMetaEl = document.getElementById("chat-meta");
      const chatHistoryEl = document.getElementById("chat-history");
      const textarea = document.getElementById("chat-input");
      const sendBtn = document.getElementById("send-btn");
      const addProjectBtn = document.getElementById("add-project-btn");
      const addChatBtn = document.getElementById("add-chat-btn");
      const resetBtn = document.getElementById("reset-btn");
      const form = document.getElementById("chat-form");

      const renameProjectBtn = document.getElementById("rename-project-btn");
      const deleteProjectBtn = document.getElementById("delete-project-btn");
      const renameChatBtn = document.getElementById("rename-chat-btn");
      const deleteChatBtn = document.getElementById("delete-chat-btn");

      // --- Рендер ---

      function renderProjects() {
        const project = getActiveProject();
        currentProjectLabelEl.textContent = project ? project.name : "—";

        projectsListEl.innerHTML = "";
        state.projects.forEach((p, index) => {
          const btn = document.createElement("button");
          btn.type = "button";
          btn.className =
            "sidebar-item" + (p.id === state.activeProjectId ? " active" : "");
          btn.innerHTML = `
            <span>${p.name}</span>
            <span>${p.description || "Проект #" + (index + 1)}</span>
          `;
          btn.addEventListener("click", () => {
            state.activeProjectId = p.id;
            if (p.chats.length) {
              state.activeChatId = p.chats[0].id;
            } else {
              state.activeChatId = null;
            }
            saveState();
            renderAll();
          });
          projectsListEl.appendChild(btn);
        });
      }

      function renderChats() {
        const project = getActiveProject();
        chatsListEl.innerHTML = "";

        if (!project) {
          currentChatLabelEl.textContent = "—";
          return;
        }

        currentChatLabelEl.textContent = project.chats.length
          ? "выбран чат"
          : "нет чатов";

        project.chats.forEach((chat, index) => {
          const btn = document.createElement("button");
          btn.type = "button";
          btn.className =
            "sidebar-item" + (chat.id === state.activeChatId ? " active" : "");
          const count = chat.messages.length;
          btn.innerHTML = `
            <span>${chat.title}</span>
            <span>${count ? count + " сообщений" : "Чат #" + (index + 1)}</span>
          `;
          btn.addEventListener("click", () => {
            state.activeChatId = chat.id;
            saveState();
            renderAll();
          });
          chatsListEl.appendChild(btn);
        });
      }

      function renderMessages() {
        const chat = getActiveChat();

        chatHistoryEl.innerHTML = "";

        if (!chat) {
          chatTitleEl.textContent = "Нет выбранного чата";
          chatSubtitleEl.textContent =
            "Создай чат слева, чтобы начать диалог.";
          chatMetaEl.textContent = "";
          sendBtn.disabled = true;
          textarea.value = "";
          return;
        }

        chatTitleEl.textContent = chat.title;
        const project = getActiveProject();
        chatSubtitleEl.textContent = project ? "Проект: " + project.name : "";
        chatMetaEl.textContent = chat.messages.length + " сообщений";

        chat.messages.forEach((msg) => {
          const bubble = document.createElement("div");
          bubble.classList.add("msg");
          bubble.classList.add(
            msg.role === "user" ? "msg-user" : "msg-raya"
          );
          bubble.innerHTML = `
            <div class="msg-meta">
              ${msg.role === "user" ? "Ты" : "Рая"} • ${msg.ts || ""}
            </div>
            <div>${msg.text}</div>
          `;
          chatHistoryEl.appendChild(bubble);
        });

        chatHistoryEl.scrollTop = chatHistoryEl.scrollHeight;
      }

      function renderAll() {
        renderProjects();
        renderChats();
        renderMessages();
      }

      // --- Обработчики кнопок ---

      addProjectBtn.addEventListener("click", () => {
        const index = state.projects.length + 1;
        const suggested = "Проект " + index;
        const name = prompt("Название проекта:", suggested);
        if (!name) return;
        const id = makeId();
        const newProject = {
          id,
          name,
          description: "",
          chats: [],
        };
        state.projects.push(newProject);
        state.activeProjectId = id;
        state.activeChatId = null;
        saveState();
        renderAll();
      });

      addChatBtn.addEventListener("click", () => {
        let project = getActiveProject();
        if (!project) {
          alert("Сначала создай или выбери проект.");
          return;
        }
        const index = project.chats.length + 1;
        const suggested = "Чат " + index;
        const title = prompt("Название чата:", suggested);
        if (!title) return;

        const chatId = makeId();
        const newChat = {
          id: chatId,
          title,
          messages: [],
        };
        project.chats.push(newChat);
        state.activeChatId = chatId;
        saveState();
        renderAll();
      });

      resetBtn.addEventListener("click", () => {
        if (!confirm("Сбросить все проекты и чаты?")) return;
        localStorage.removeItem(STORAGE_KEY);
        state = buildInitialState();
        saveState();
        renderAll();
      });

      // --- Переименование / удаление проектов и чатов ---

      renameProjectBtn.addEventListener("click", () => {
        const project = getActiveProject();
        if (!project) {
          alert("Сначала выбери проект.");
          return;
        }
        const name = prompt("Новое название проекта:", project.name);
        if (!name) return;
        project.name = name;
        saveState();
        renderAll();
      });

      deleteProjectBtn.addEventListener("click", () => {
        const project = getActiveProject();
        if (!project) {
          alert("Сначала выбери проект.");
          return;
        }
        if (
          !confirm(
            `Удалить проект «${project.name}» вместе со всеми его чатами?`
          )
        ) {
          return;
        }
        state.projects = state.projects.filter((p) => p.id !== project.id);
        if (!state.projects.length) {
          state = buildInitialState();
        } else {
          state.activeProjectId = state.projects[0].id;
          const first = state.projects[0];
          state.activeChatId = first.chats.length ? first.chats[0].id : null;
        }
        saveState();
        renderAll();
      });

      renameChatBtn.addEventListener("click", () => {
        const chat = getActiveChat();
        if (!chat) {
          alert("Сначала выбери чат.");
          return;
        }
        const title = prompt("Новое название чата:", chat.title);
        if (!title) return;
        chat.title = title;
        saveState();
        renderAll();
      });

      deleteChatBtn.addEventListener("click", () => {
        const project = getActiveProject();
        const chat = getActiveChat();
        if (!project || !chat) {
          alert("Сначала выбери чат.");
          return;
        }
        if (!confirm(`Удалить чат «${chat.title}»?`)) return;
        project.chats = project.chats.filter((c) => c.id !== chat.id);
        if (project.chats.length) {
          state.activeChatId = project.chats[0].id;
        } else {
          state.activeChatId = null;
        }
        saveState();
        renderAll();
      });

      // --- Enter / Shift+Enter для ввода ---

      textarea.addEventListener("input", () => {
        sendBtn.disabled = !textarea.value.trim() || !getActiveChat();
      });

      textarea.addEventListener("keydown", (event) => {
        if (event.key === "Enter" && !event.shiftKey) {
          const chat = getActiveChat();
          if (!chat) return;
          event.preventDefault();
          if (typeof form.requestSubmit === "function") {
            form.requestSubmit();
          } else {
            form.dispatchEvent(
              new Event("submit", { cancelable: true, bubbles: true })
            );
          }
        }
      });

      form.addEventListener("submit", (event) => {
        event.preventDefault();
        const chat = getActiveChat();
        if (!chat) return;
        const text = textarea.value.trim();
        if (!text) return;

        const ts = new Date().toLocaleTimeString().slice(0, 5);

        chat.messages.push({
          id: makeId(),
          role: "user",
          text,
          ts,
        });

        textarea.value = "";
        sendBtn.disabled = true;

        setTimeout(() => {
          chat.messages.push({
            id: makeId(),
            role: "raya",
            text:
              "Я пока отвечаю как заглушка.\n" +
              "Позже сюда прикрутим реальный запрос к API, как только ты захочешь.",
            ts: new Date().toLocaleTimeString().slice(0, 5),
          });
          saveState();
          renderAll();
        }, 300);

        saveState();
        renderAll();
      });

      // --- Первый рендер ---
      renderAll();
    </script>
  </body>
</html>
